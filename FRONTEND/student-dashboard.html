<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Accommodation</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f6fb;
    color: #333;
}

header {
    background: linear-gradient(135deg, #1e7f74 0%, #16635f 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

header h2 {
    font-size: 24px;
}

.logout {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.logout:hover {
    background: #c0392b;
}

.container {
    padding: 30px;
    max-width: 1400px;
    margin: 0 auto;
}

h3 {
    margin: 30px 0 20px 0;
    color: #1e7f74;
    font-size: 22px;
    border-bottom: 2px solid #1e7f74;
    padding-bottom: 10px;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    text-align: center;
}

.stat h4 {
    color: #777;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat p {
    font-size: 32px;
    font-weight: bold;
    color: #1e7f74;
    margin-top: 10px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background: #e0e0e0;
    display: block;
}

.card-body {
    padding: 18px;
}

.card-body h3 {
    margin: 0 0 10px 0;
    border: none;
    padding: 0;
    font-size: 18px;
}

.card-body p {
    margin: 8px 0;
    color: #666;
    font-size: 14px;
}

.button {
    display: inline-block;
    margin-top: 12px;
    width: 100%;
    background: #1e7f74;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.3s;
}

.button:hover {
    background: #16635f;
}

.button.secondary {
    background: #3498db;
}

.button.secondary:hover {
    background: #2980b9;
}

.button.danger {
    background: #e74c3c;
}

.button.danger:hover {
    background: #c0392b;
}

.empty {
    background: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    color: #999;
    font-size: 16px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.alert.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.booking-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    border-left: 4px solid #1e7f74;
}

.booking-card h4 {
    margin: 0 0 10px 0;
    color: #1e7f74;
}

.booking-card p {
    margin: 8px 0;
    color: #666;
    font-size: 14px;
}

.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-allocated {
    background: #d4edda;
    color: #155724;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}
    </style>
</head>

<body>

<header>
    <h2>Student Dashboard</h2>
    <button class="logout" onclick="logoutFunc()">Logout</button>
</header>

<div class="container">

    <h3 id="welcome">Welcome back üëã</h3>

    <!-- ALERTS -->
    <div id="alertContainer"></div>

    <!-- NORMAL VIEW - Browse Hostels -->
    <div id="normalView">

        <div class="stats">
            <div class="stat">
                <h4>Total Bookings</h4>
                <p id="totalBookings">0</p>
            </div>
            <div class="stat">
                <h4>Pending Approval</h4>
                <p id="pendingBookings">0</p>
            </div>
            <div class="stat">
                <h4>Active Bookings</h4>
                <p id="acceptedBookings">0</p>
            </div>
            <div class="stat">
                <h4>Total Paid</h4>
                <p id="totalPaid">KSh 0</p>
            </div>
        </div>

        <h3>Available Hostels</h3>
        <div id="hostels" class="grid"></div>

        <h3>My Bookings</h3>
        <div id="bookings"></div>

    </div>

    <!-- ALLOCATED VIEW - Dashboard for Allocated Student -->
    <div id="allocatedView" style="display:none">

        <div class="stats">
            <div class="stat">
                <h4>Allocated Hostel</h4>
                <p id="allocatedHostelName">-</p>
            </div>
            <div class="stat">
                <h4>Room Number</h4>
                <p id="allocatedRoomNumber">-</p>
            </div>
            <div class="stat">
                <h4>Floor</h4>
                <p id="allocatedFloor">-</p>
            </div>
        </div>

        <h3>üè† My Allocated Hostel</h3>
        <div id="allocatedCard" class="grid"></div>

        <h3>üí≥ Make Payment</h3>
        <div class="card">
            <div class="card-body">
                <div class="form-group">
                    <label>Amount (KSh)</label>
                    <input type="number" id="paymentAmount" placeholder="Enter amount" min="100">
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option value="MPESA">M-PESA</option>
                        <option value="CARD">Card</option>
                        <option value="BANK">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transaction ID</label>
                    <input type="text" id="transactionId" placeholder="Enter transaction ID">
                </div>
                <button class="button secondary" onclick="makePaymentFunc()">Submit Payment</button>
            </div>
        </div>

        <h3>üí∞ Payment History</h3>
        <div id="paymentHistory"></div>

        <h3>üõ† Report Maintenance Issue</h3>
        <div class="card">
            <div class="card-body">
                <div class="form-group">
                    <label>Issue Title</label>
                    <input type="text" id="issueTitle" placeholder="e.g., Broken Window">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="issueDescription" placeholder="Describe the issue in detail..."></textarea>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="issuePriority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                    </select>
                </div>
                <button class="button" onclick="reportIssueFunc()">Submit Issue</button>
            </div>
        </div>

        <h3>üì¢ Notices From Owner</h3>
        <div id="notices"></div>

    </div>

</div>

<script src="api-client.js"></script>
<script>

// Initialize
initAuth();
let currentAllocatedBooking = null;

// ============= FUNCTIONS =============

function updateWelcome() {
    if (currentUser) {
        document.getElementById('welcome').textContent = `Welcome back, ${currentUser.email}! üëã`;
    }
}

function showAlert(message, type = 'success') {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert ${type === 'error' ? 'error' : 'success'}`;
    alert.textContent = message;
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function logoutFunc() {
    logoutUser();
    window.location.href = '/login.html';
}

function formatCurrency(amount) {
    return 'KSh ' + parseFloat(amount).toLocaleString('en-KE', { minimumFractionDigits: 2 });
}

function getStatusBadge(status) {
    const statusClass = {
        'PENDING': 'status-pending',
        'FINAL_ALLOCATED': 'status-allocated',
        'CANCELLED': 'status-cancelled'
    }[status] || 'status-pending';
    return `<span class="status-badge ${statusClass}">${status}</span>`;
}

// ============= HOSTELS =============

async function loadHostels() {
    try {
        const data = await getAllHostels();
        const hostels = data.hostels || [];

        if (!Array.isArray(hostels) || hostels.length === 0) {
            document.getElementById('hostels').innerHTML = '<div class="empty">No hostels available</div>';
            return;
        }

        document.getElementById('hostels').innerHTML = hostels.map(h => `
            <div class="card">
                <img 
                    src="${h.image || 'https://via.placeholder.com/400x250?text=Hostel+Image'}" 
                    alt="${h.name}"
                    onerror="this.src='https://via.placeholder.com/400x250?text=Hostel+Image'"
                    loading="lazy"
                >
                <div class="card-body">
                    <h3>${h.name}</h3>
                    <p>üìç ${h.location}</p>
                    <p style="color:#666; font-size:13px;">${h.description || 'Quality accommodation'}</p>
                    <p><b>${formatCurrency(h.price_per_month)}/month</b></p>
                    ${h.amenities ? `<p style="font-size:12px; color:#888;">‚úì ${h.amenities}</p>` : ''}
                    <p style="font-size:12px; color:#1e7f74;"><b>${h.total_rooms} rooms ‚Ä¢ ${h.available_rooms} available</b></p>
                    <button class="button" onclick="bookHostelFunc('${h.id}', '${h.name}')">üìå Book Now</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading hostels:', error);
        showAlert('Failed to load hostels', 'error');
    }
}

// ============= BOOK HOSTEL =============

async function bookHostelFunc(hostelId, hostelName) {
    if (!confirm(`Book ${hostelName}?`)) return;

    try {
        const result = await bookHostel({hostel_id: hostelId});
        if (result && result.booking) {
            showAlert('‚úÖ Booking request sent! Owner will review and approve.');
            loadBookings();
        } else {
            showAlert('Failed to create booking', 'error');
        }
    } catch (error) {
        console.error('Booking error:', error);
    }
}

// ============= BOOKINGS =============

async function loadBookings() {
    try {
        const data = await getMyBookings();
        const bookings = data.bookings || [];

        // Check for allocated booking
        const allocated = bookings.find(b => b.status === 'FINAL_ALLOCATED');
        if (allocated) {
            currentAllocatedBooking = allocated;
            showAllocatedDashboard(allocated);
            return;
        }

        updateStats(bookings);

        const bookingsDiv = document.getElementById('bookings');
        if (bookings.length === 0) {
            bookingsDiv.innerHTML = '<div class="empty">No bookings yet. Browse and book a hostel above.</div>';
            return;
        }

        bookingsDiv.innerHTML = bookings.map(b => `
            <div class="booking-card">
                <h4>${b.hostel.name}</h4>
                <p><strong>Location:</strong> ${b.hostel.location}</p>
                <p><strong>Status:</strong> ${getStatusBadge(b.status)}</p>
                <p><strong>Booked:</strong> ${new Date(b.booking_date).toLocaleDateString()}</p>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading bookings:', error);
        showAlert('Failed to load bookings', 'error');
    }
}

function updateStats(bookings) {
    document.getElementById('totalBookings').textContent = bookings.length;
    document.getElementById('pendingBookings').textContent = bookings.filter(b => b.status === 'PENDING').length;
    document.getElementById('acceptedBookings').textContent = bookings.filter(b => b.status === 'FINAL_ALLOCATED').length;
}

// ============= ALLOCATED DASHBOARD =============

function switchToAllocatedView() {
    if (currentAllocatedBooking) {
        showAllocatedDashboard(currentAllocatedBooking);
    }
}

async function showAllocatedDashboard(booking) {
    document.getElementById('normalView').style.display = 'none';
    document.getElementById('allocatedView').style.display = 'block';

    // Update stats
    document.getElementById('allocatedHostelName').textContent = booking.hostel.name;
    document.getElementById('allocatedRoomNumber').textContent = booking.room_number || (booking.room ? booking.room.room_number : 'TBD');
    document.getElementById('allocatedFloor').textContent = (booking.room ? booking.room.floor : '-');

    // Show hostel card
    const h = booking.hostel;
    document.getElementById('allocatedCard').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h3>${h.name}</h3>
                <p>üìç ${h.location}</p>
                <p><strong>Price:</strong> ${formatCurrency(h.price_per_month)}/month</p>
                ${h.amenities ? `<p><strong>Amenities:</strong> ${h.amenities}</p>` : ''}
                ${booking.room ? `<p><strong>Room:</strong> ${booking.room.room_number} (Floor ${booking.room.floor})</p>` : ''}
            </div>
        </div>
    `;

    // Load payment history
    loadPaymentHistory();

    // Load notices
    loadNotices(h.id);
}

// ============= PAYMENTS =============

async function makePaymentFunc() {
    if (!currentAllocatedBooking) {
        showAlert('No active booking found', 'error');
        return;
    }

    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const transactionId = document.getElementById('transactionId').value.trim();

    if (!amount || amount <= 0) {
        showAlert('Enter a valid amount', 'error');
        return;
    }

    if (!transactionId) {
        showAlert('Enter transaction ID', 'error');
        return;
    }

    try {
        const result = await makePayment({
            booking_id: currentAllocatedBooking.id,
            amount: amount,
            payment_method: method,
            transaction_id: transactionId
        });

        if (result && result.payment) {
            showAlert('‚úÖ Payment recorded successfully!');
            document.getElementById('paymentAmount').value = '';
            document.getElementById('transactionId').value = '';
            loadPaymentHistory();
            loadBookings();
        } else {
            showAlert('Failed to record payment', 'error');
        }
    } catch (error) {
        console.error('Payment error:', error);
        showAlert('Error recording payment', 'error');
    }
}

async function loadPaymentHistory() {
    if (!currentAllocatedBooking) return;

    try {
        const data = await getMyPayments();
        const payments = (data.payments || []).filter(p => p.booking_id === currentAllocatedBooking.id);

        const historyDiv = document.getElementById('paymentHistory');
        if (payments.length === 0) {
            historyDiv.innerHTML = '<div class="empty">No payments recorded yet</div>';
            return;
        }

        const total = payments.reduce((sum, p) => sum + p.amount, 0);
        historyDiv.innerHTML = `
            <div class="booking-card">
                <h4>Total Paid: ${formatCurrency(total)}</h4>
                ${payments.map(p => `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <p><strong>${formatCurrency(p.amount)}</strong> - ${p.method}</p>
                        <p style="color: #999; font-size: 12px;">Transaction: ${p.transaction_id}</p>
                        <p style="color: #999; font-size: 12px;">Date: ${new Date(p.created_at).toLocaleDateString()}</p>
                    </div>
                `).join('')}
            </div>
        `;

        // Update total paid in stats
        document.getElementById('totalPaid').textContent = formatCurrency(total);
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

// ============= ISSUES =============

async function reportIssueFunc() {
    if (!currentAllocatedBooking) {
        showAlert('No active booking found', 'error');
        return;
    }

    const title = document.getElementById('issueTitle').value.trim();
    const description = document.getElementById('issueDescription').value.trim();
    const priority = document.getElementById('issuePriority').value;

    if (!title || !description) {
        showAlert('Fill in all fields', 'error');
        return;
    }

    try {
        const result = await reportIssue({
            hostel_id: currentAllocatedBooking.hostel.id,
            title: title,
            description: description,
            priority: priority
        });

        if (result && result.issue) {
            showAlert('‚úÖ Issue reported! Owner will review soon.');
            document.getElementById('issueTitle').value = '';
            document.getElementById('issueDescription').value = '';
            document.getElementById('issuePriority').value = 'MEDIUM';
        } else {
            showAlert('Failed to report issue', 'error');
        }
    } catch (error) {
        console.error('Issue error:', error);
        showAlert('Error reporting issue', 'error');
    }
}

// ============= NOTICES =============

async function loadNotices(hostelId) {
    try {
        const data = await getNotices(hostelId);
        const notices = data.notices || [];

        const noticesDiv = document.getElementById('notices');
        if (notices.length === 0) {
            noticesDiv.innerHTML = '<div class="empty">No notices yet</div>';
            return;
        }

        noticesDiv.innerHTML = notices.map(n => `
            <div class="card">
                <div class="card-body">
                    <h4>${n.title}</h4>
                    <p>${n.message}</p>
                    <p style="color: #999; font-size: 12px;">
                        ${new Date(n.created_at).toLocaleDateString()} - Priority: ${n.priority}
                    </p>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading notices:', error);
    }
}

// ============= INIT =============

async function initDashboard() {
    if (!currentUser || currentUser.role !== 'student') {
        alert('Session expired or unauthorized');
        window.location.href = '/login.html';
        return;
    }
    
    updateWelcome();
    
    try {
        // Load dashboard stats first
        const dashboardData = await getStudentDashboard();
        if (dashboardData) {
            document.getElementById('totalBookings').textContent = dashboardData.total_bookings || 0;
            document.getElementById('pendingBookings').textContent = dashboardData.recent_bookings ? dashboardData.recent_bookings.filter(b => b.status === 'PENDING').length : 0;
            document.getElementById('activeBookings').textContent = dashboardData.active_booking ? 1 : 0;
            document.getElementById('totalIssues').textContent = (dashboardData.pending_issues || 0) + (dashboardData.resolved_issues || 0);
            document.getElementById('totalPaid').textContent = formatCurrency(dashboardData.total_paid || 0);
            
            // If user has active booking, switch to allocated view
            if (dashboardData.active_booking) {
                currentAllocatedBooking = dashboardData.active_booking;
                switchToAllocatedView();
            }
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
    
    // Load other data
    await loadHostels();
    await loadBookings();
}

window.addEventListener('load', initDashboard);

</script>

</body>
</html>