<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Accommodation</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',sans-serif; background:#f4f6fb; color:#333; }
        header { background:#1e7f74; color:white; padding:20px 30px; display:flex; justify-content:space-between; align-items:center; }
        .logout { background:#e74c3c; border:none; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; }
        .sidebar { display:flex; background:white; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        .sidebar button { flex:1; padding:15px; border:none; background:transparent; cursor:pointer; color:#666; font-size:14px; transition:.2s; border-bottom:3px solid transparent; }
        .sidebar button.active { color:#1e7f74; border-bottom-color:#1e7f74; }
        .container { padding:30px; }
        .section { display:none; }
        .section.active { display:block; }
        .card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
        .stat { background:white; padding:20px; border-radius:10px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        .stat h4 { color:#666; font-size:12px; margin-bottom:10px; }
        .stat p { font-size:28px; font-weight:bold; color:#1e7f74; }
        h2 { color:#1e7f74; margin-bottom:20px; }
        .hostel-item { background:white; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #1e7f74; }
        .hostel-item h4 { color:#1e7f74; margin-bottom:8px; }
        .hostel-item p { color:#666; font-size:14px; margin-bottom:8px; }
        .btn { padding:8px 16px; background:#1e7f74; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:8px; }
        .btn-danger { background:#e74c3c; }
        .btn:hover { opacity:0.9; }
        .form-group { margin-bottom:15px; }
        label { display:block; margin-bottom:5px; color:#666; font-size:14px; }
        input, textarea, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-family:inherit; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; padding:30px; border-radius:10px; width:90%; max-width:500px; }
        .close-modal { float:right; cursor:pointer; font-size:20px; color:#999; }
        .payment-method { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:10px 0; }
        .payment-option { padding:10px; border:2px solid #ddd; border-radius:6px; cursor:pointer; text-align:center; transition:.2s; }
        .payment-option.selected { border-color:#1e7f74; background:#f0fffe; }
        .rooms-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; }
        .room-card { background:white; padding:15px; border-radius:8px; text-align:center; border:1px solid #ddd; }
        .room-card h4 { color:#1e7f74; margin-bottom:10px; }
        .room-card .occupied { color:#e74c3c; font-size:12px; }
        .room-card .available { color:#27ae60; font-size:12px; }
    </style>
</head>
<body>

<header>
    <h2>üë®‚Äçüéì Student Dashboard</h2>
    <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="sidebar">
    <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
    <button class="tab-btn" onclick="switchTab('browse')">Browse Hostels</button>
    <button class="tab-btn" onclick="switchTab('bookings')">My Bookings</button>
    <button class="tab-btn" onclick="switchTab('payments')">Payments</button>
    <button class="tab-btn" onclick="switchTab('complaints')">Complaints</button>
</div>

<div class="container">
    <!-- OVERVIEW -->
    <div id="overview" class="section active">
        <h2>Welcome, <span id="userName">Guest</span>! üëã</h2>
        <div class="grid">
            <div class="stat">
                <h4>Active Booking</h4>
                <p id="activeBooking">-</p>
            </div>
            <div class="stat">
                <h4>Total Paid</h4>
                <p><span id="totalPaid">0</span></p>
            </div>
            <div class="stat">
                <h4>Pending Issues</h4>
                <p id="pendingIssues">0</p>
            </div>
            <div class="stat">
                <h4>Resolved Issues</h4>
                <p id="resolvedIssues">0</p>
            </div>
        </div>
        <div class="card" style="margin-top:30px;">
            <h3>Recent Bookings</h3>
            <div id="recentBookings" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- BROWSE HOSTELS -->
    <div id="browse" class="section">
        <h2>Browse Available Hostels</h2>
        <div id="hostelsList" class="grid"></div>
    </div>

    <!-- BOOKINGS -->
    <div id="bookings" class="section">
        <h2>My Bookings</h2>
        <div id="myBookings"></div>
    </div>

    <!-- PAYMENTS -->
    <div id="payments" class="section">
        <h2>Payment Management</h2>
        <div class="card">
            <h3>Your Payments</h3>
            <div id="paymentsList" style="margin-top:15px;"></div>
        </div>
    </div>

  <!-- COMPLAINTS -->
<div id="complaints" class="section">
    <h2>Report Issue</h2>
    <div class="card">
        <h3>Submit a Complaint</h3>
        <div class="form-group">
            <label>Your Allocated Hostel</label>
            <input type="text" id="complaintHostelName" readonly style="background: #f5f5f5; cursor: not-allowed;" placeholder="Loading...">
            <input type="hidden" id="complaintHostel">
        </div>
        <div class="form-group">
            <label>Issue Title</label>
            <input type="text" id="complaintTitle" placeholder="e.g., Broken water pipe">
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="complaintDesc" rows="4" placeholder="Describe the issue in detail..."></textarea>
        </div>
        <div class="form-group">
            <label>Priority</label>
            <select id="complaintPriority">
                <option value="LOW">Low</option>
                <option value="MEDIUM" selected>Medium</option>
                <option value="HIGH">High</option>
            </select>
        </div>
        <button class="btn btn-success" onclick="submitComplaint()">Submit Complaint</button>
    </div>

    <h3>My Complaints</h3>
    <div id="complaintsList"></div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('paymentModal')">&times;</span>
        <h3>Pay Hostel Fees</h3>
        <form onsubmit="processPayment(event)">
            <div class="form-group">
                <label>Select Booking</label>
                <select id="paymentBooking" required>
                    <option value="">Choose a booking...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="paymentAmount" min="0" required placeholder="Enter amount to pay">
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div class="payment-option" onclick="selectPaymentMethod('MPESA')" style="cursor: pointer; padding: 15px; border: 2px solid #ddd; border-radius: 8px; text-align: center; transition: all 0.3s;">
                        <strong>M-PESA</strong>
                    </div>
                    <div class="payment-option" onclick="selectPaymentMethod('BANK')" style="cursor: pointer; padding: 15px; border: 2px solid #ddd; border-radius: 8px; text-align: center; transition: all 0.3s;">
                        <strong>Bank Transfer</strong>
                    </div>
                </div>
                <input type="hidden" id="selectedPaymentMethod" required>
            </div>
            <div class="form-group">
                <label>Transaction ID</label>
                <input type="text" id="transactionId" required placeholder="e.g., MPE123456789">
            </div>
            <button type="submit" class="btn btn-success">Submit Payment</button>
        </form>
    </div>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    let authToken = null;
    let currentUser = null;

    // Initialize
    window.onload = () => {
        const token = localStorage.getItem('access_token');
        const user = localStorage.getItem('user');
        
        if (!token || !user) {
            window.location.href = '/login.html';
            return;
        }
        
        authToken = token;
        currentUser = JSON.parse(user);
        
        if (currentUser.role !== 'student') {
            window.location.href = '/owner-dash.html';
            return;
        }
        
        document.getElementById('userName').textContent = currentUser.first_name || currentUser.email;
        loadDashboard();
    };

    async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            }
        };
        if (data) options.body = JSON.stringify(data);
        
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        return res.json();
    }

    async function loadDashboard() {
        const data = await apiCall('/dashboard/student/');
        document.getElementById('activeBooking').textContent = data.active_booking ? 'Yes' : 'No';
        document.getElementById('totalPaid').textContent = data.total_paid || 0;
        document.getElementById('pendingIssues').textContent = data.pending_issues || 0;
        document.getElementById('resolvedIssues').textContent = data.resolved_issues || 0;
        
        if (data.recent_bookings && data.recent_bookings.length > 0) {
            document.getElementById('recentBookings').innerHTML = data.recent_bookings.map(b => `
                <div class="hostel-item">
                    <h4>${b.hostel.name}</h4>
                    <p>Status: <strong>${b.status}</strong></p>
                    <p>Booking Date: ${new Date(b.booking_date).toLocaleDateString()}</p>
                </div>
            `).join('');
        }
        
        loadHostels();
        loadMyBookings();
        loadPayments();
    }

    async function loadHostels() {
        const data = await apiCall('/hostels/', 'GET');
        const html = data.hostels.map(h => {
            const imagesHtml = h.images && h.images.length > 0 
                ? `<div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
                     ${h.images.map(img => `<img src="${img.image_url}" alt="${img.caption}" style="width: 120px; height: 100px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">`).join('')}
                   </div>`
                : (h.image ? `<img src="${h.image}" alt="${h.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 6px; margin-bottom: 15px;">` : '');
            
            return `
            <div class="card">
                ${imagesHtml}
                <h4>${h.name}</h4>
                <p><strong>Location:</strong> ${h.location}</p>
                <p><strong>Price:</strong> ‚Çπ${h.price_per_month}/month</p>
                <p><strong>Available Rooms:</strong> ${h.available_rooms}/${h.total_rooms}</p>
                <p>${h.description}</p>
                ${h.amenities ? `<p><strong>Amenities:</strong> ${h.amenities}</p>` : ''}
                <button class="btn" onclick="bookHostel('${h.id}')">Book Room</button>
            </div>
        `;
        }).join('');
        document.getElementById('hostelsList').innerHTML = html;
    }

   async function loadMyBookings() {
    try {
        const bookingsData = await apiCall('/bookings/my/');
        const bookings = bookingsData.bookings || [];
        
        // Load payments to check which bookings are already paid
        const paymentsData = await apiCall('/payments/my/');
        const payments = paymentsData.payments || [];
        
        if (bookings.length === 0) {
            document.getElementById('myBookings').innerHTML = '<p style="color:#666; text-align:center;">No bookings yet</p>';
            return;
        }
        
        const html = bookings.map(b => {
            // Check if this booking has been paid
            const hasPaid = payments.some(p => p.booking_id === b.id);
            const isAllocated = b.status === 'FINAL_ALLOCATED' || b.status === 'ALLOCATED';
            const isRejected = b.status === 'CANCELLED';
            const isPending = b.status === 'PENDING';
            
            return `
                <div class="hostel-item">
                    <h4>${b.hostel.name}</h4>
                    <p>Status: <strong>${b.status}</strong></p>
                    <p>Booking Date: ${new Date(b.booking_date).toLocaleDateString()}</p>
                    ${b.room ? `<p>Room: ${b.room.room_number} (Floor ${b.room.floor})</p>` : ''}
                    
                    ${isRejected ? 
                        `<div style="background: #f8d7da; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #dc3545;">
                            <strong style="color: #721c24;">‚ùå Booking Rejected</strong>
                            ${b.rejection_reason ? `<p style="margin: 5px 0 0; color: #721c24; font-size: 12px;">Reason: ${b.rejection_reason}</p>` : ''}
                        </div>` 
                    : hasPaid ? 
                        '<div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #28a745;"><strong style="color: #155724;">‚úì Payment Submitted</strong></div>' 
                    : isAllocated ? 
                        `<button class="btn" onclick="openPaymentModal('${b.id}')">Pay Fees</button>` 
                    : isPending ?
                        '<p style="color: orange;">‚è≥ Awaiting Owner Approval</p>'
                    : ''}
                </div>
            `;
        }).join('');
        
        document.getElementById('myBookings').innerHTML = html;
        
    } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('myBookings').innerHTML = '<p style="color:red; text-align:center;">Error loading bookings</p>';
    }
}

    async function loadPayments() {
        const data = await apiCall('/payments/my/');
        const html = data.payments.map(p => `
            <div class="hostel-item">
                <h4>${p.hostel} - ‚Çπ${p.amount}</h4>
                <p>Status: <strong>${p.status}</strong></p>
                <p>Method: ${p.method}</p>
                <p>Date: ${new Date(p.created_at).toLocaleDateString()}</p>
            </div>
        `).join('');
        document.getElementById('paymentsList').innerHTML = html || '<p>No payments yet</p>';
    }

   async function bookHostel(hostelId) {
    const res = await apiCall('/bookings/book/', 'POST', {
        hostel_id: hostelId
    });
    
    if (res.message || res.booking) {
        alert('Booking created! Waiting for owner approval.');
        loadMyBookings();
        loadDashboard();
    } else {
        alert(res.error || 'Booking failed');
    }
}

async function openPaymentModal(bookingId) {
    try {
        // Load all bookings
        const bookingsData = await apiCall('/bookings/my/');
        const bookings = bookingsData.bookings || [];
        
        if (bookings.length === 0) {
            alert('No bookings found. Please book a hostel first.');
            return;
        }
        
        // Load existing payments to check which bookings are already paid
        const paymentsData = await apiCall('/payments/my/');
        const existingPayments = paymentsData.payments || [];
        
        console.log('Existing payments:', existingPayments);
        
        // Filter bookings that haven't been paid yet
        const unpaidBookings = bookings.filter(b => {
            const hasPaid = existingPayments.some(p => p.booking_id === b.id);
            const isAllocated = b.status === 'FINAL_ALLOCATED' || b.status === 'ALLOCATED';
            return !hasPaid && isAllocated;
        });
        
        console.log('Unpaid bookings:', unpaidBookings);
        
        if (unpaidBookings.length === 0) {
            alert('‚úÖ All your bookings have been paid for, or you have no approved bookings yet.');
            return;
        }
        
        // Populate the select dropdown with ONLY unpaid bookings
        const select = document.getElementById('paymentBooking');
        select.innerHTML = unpaidBookings.map(b => `
            <option value="${b.id}">
                ${b.hostel.name} - ‚Çπ${b.room?.price_per_month || b.hostel.price_per_month}
            </option>
        `).join('');
        
        // Pre-select the current booking if provided and it's unpaid
        if (bookingId && unpaidBookings.some(b => b.id === bookingId)) {
            select.value = bookingId;
        }
        
        // Auto-fill amount based on room or hostel price
        const selectedBooking = unpaidBookings.find(b => b.id === (bookingId || select.value));
        if (selectedBooking) {
            const amount = selectedBooking.room?.price_per_month || selectedBooking.hostel.price_per_month || 0;
            document.getElementById('paymentAmount').value = amount;
        }
        
        // Reset payment method selection
        document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('selectedPaymentMethod').value = '';
        document.getElementById('transactionId').value = '';
        
        document.getElementById('paymentModal').classList.add('active');
        
    } catch (error) {
        console.error('Error opening payment modal:', error);
        alert('Failed to load payment information. Please try again.');
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function selectPaymentMethod(method) {
    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
    event.target.closest('.payment-option').classList.add('selected');  
    document.getElementById('selectedPaymentMethod').value = method;
}

    async function processPayment(e) {
        e.preventDefault();
        const bookingId = document.getElementById('paymentBooking').value;
        const amount = document.getElementById('paymentAmount').value;
        const method = document.getElementById('selectedPaymentMethod').value;
        const transactionId = document.getElementById('transactionId').value;
        
        const res = await apiCall('/payments/make/', 'POST', {
            booking_id: bookingId,
            amount: parseFloat(amount),
            payment_method: method,
            transaction_id: transactionId
        });
        
        if (res.message) {
            alert('Payment recorded successfully!');
            closeModal('paymentModal');
            loadPayments();
        } else {
            alert(res.error || 'Payment failed');
        }
    }

    function updatePaymentAmount() {
    // This will auto-update amount when booking is changed
    openPaymentModal(document.getElementById('paymentBooking').value);
    }

async function submitComplaint() {
    const hostelId = document.getElementById('complaintHostel').value;
    const title = document.getElementById('complaintTitle').value;
    const desc = document.getElementById('complaintDesc').value;
    const priority = document.getElementById('complaintPriority').value;
    
    if (!hostelId) {
        alert('You must have an allocated hostel to report an issue. Please wait for your booking to be approved.');
        return;
    }
    
    if (!title || !desc) {
        alert('Please fill in both title and description');
        return;
    }
    
    const res = await apiCall('/issues/report/', 'POST', {
        hostel_id: hostelId,
        title: title,
        description: desc,
        priority: priority
    });
    
    if (res.message) {
        alert('‚úÖ Complaint submitted successfully!');
        document.getElementById('complaintTitle').value = '';
        document.getElementById('complaintDesc').value = '';
        document.getElementById('complaintPriority').value = 'MEDIUM';
        loadComplaints();
    } else {
        alert(res.error || 'Failed to submit complaint');
    }
}

// Load allocated hostel when switching to complaints tab
async function loadAllocatedHostel() {
    try {
        const data = await apiCall('/bookings/my/');
        const allocatedBooking = data.bookings.find(b => 
            b.status === 'FINAL_ALLOCATED' && b.room
        );
        
        if (allocatedBooking) {
            document.getElementById('complaintHostel').value = allocatedBooking.hostel.id;
            document.getElementById('complaintHostelName').value = allocatedBooking.hostel.name;
            document.getElementById('complaintHostelName').style.color = '#333';
        } else {
            document.getElementById('complaintHostel').value = '';
            document.getElementById('complaintHostelName').value = 'No allocated hostel yet';
            document.getElementById('complaintHostelName').style.color = '#999';
        }
    } catch (error) {
        console.error('Error loading hostel:', error);
        document.getElementById('complaintHostelName').value = 'Error loading hostel';
    }
}

async function loadComplaints() {  
    try {
        const data = await apiCall('/issues/my/');  
        
        if (!data.issues || data.issues.length === 0) {
            document.getElementById('complaintsList').innerHTML = '<p style="color:#666; text-align:center;">No complaints reported yet.</p>';
            return;
        }
        
        const html = data.issues.map(i => `
            <div class="hostel-item">
                <h4>${i.title} - <strong style="color: ${i.status === 'RESOLVED' ? 'green' : 'orange'}">${i.status}</strong></h4>
                <p><strong>Hostel:</strong> ${i.hostel}</p>
                <p>${i.description}</p>
                <p><strong>Priority:</strong> ${i.priority} | <strong>Reported:</strong> ${new Date(i.created_at).toLocaleDateString()}</p>
                ${i.status === 'RESOLVED' ? '<p style="color: green;">‚úì Issue has been resolved</p>' : '<p style="color: orange;">‚è≥ Waiting for resolution</p>'}
            </div>
        `).join('');
        
        document.getElementById('complaintsList').innerHTML = html;
        
    } catch (error) {
        console.error('Error loading complaints:', error);
        document.getElementById('complaintsList').innerHTML = '<p style="color:red; text-align:center;">Error loading complaints. Please try again.</p>';
    }
}

function switchTab(tabName) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    if (tabName === 'complaints') {
        loadAllocatedHostel();  
        loadComplaints();       
    }
}
    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
    }
</script>

</body>
</html>
