<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Test Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: monospace;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
            color: #333;
        }
        
        .output.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .output.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .output.loading {
            background: #cfe2ff;
            border-color: #b6d4fe;
            color: #084298;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #667eea;
        }
        
        .log-entry.error {
            border-left-color: #f06;
            background: #ffe6e6;
        }
        
        .log-entry.success {
            border-left-color: #0c0;
            background: #e6ffe6;
        }
        
        .timestamp {
            color: #999;
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.ok {
            background: #0c0;
        }
        
        .status-indicator.error {
            background: #f06;
        }
        
        .status-indicator.pending {
            background: #fc0;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Backend API Test Console</h1>
            <p>Test all Hostel Management System endpoints - Backend Status: <span class="status-indicator ok"></span>ONLINE</p>
        </div>
        
        <div class="grid">
            <!-- AUTHENTICATION PANEL -->
            <div class="panel">
                <h2>Authentication</h2>
                
                <div class="form-group">
                    <label>Register New User</label>
                    <input type="email" id="regEmail" placeholder="Email">
                    <input type="text" id="regName" placeholder="Full Name">
                    <input type="password" id="regPassword" placeholder="Password (min 6 chars)">
                    <select id="regRole">
                        <option value="student">Student</option>
                        <option value="owner">Owner</option>
                    </select>
                    <button onclick="testRegister()" style="margin-top: 10px;">Register</button>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                
                <div class="form-group">
                    <label>Login</label>
                    <input type="email" id="loginEmail" placeholder="Email">
                    <input type="password" id="loginPassword" placeholder="Password">
                    <button onclick="testLogin()" style="margin-top: 10px;">Login</button>
                </div>
                
                <div class="output" id="authOutput"></div>
            </div>
            
            <!-- HOSTELS PANEL -->
            <div class="panel">
                <h2>Hostels</h2>
                
                <div class="form-group">
                    <label>Get All Hostels</label>
                    <button onclick="testGetHostels()">Fetch Hostels</button>
                </div>
                
                <div class="form-group">
                    <label>Hostel ID (for details)</label>
                    <input type="text" id="hostelId" placeholder="Enter hostel ID">
                    <button onclick="testGetHostel()" style="margin-top: 10px;">Get Details</button>
                </div>
                
                <div class="output" id="hostelOutput"></div>
            </div>
            
            <!-- BOOKINGS PANEL -->
            <div class="panel">
                <h2>Bookings (Auth Required)</h2>
                
                <div class="form-group">
                    <label>Book Hostel</label>
                    <input type="text" id="bookHostelId" placeholder="Hostel ID">
                    <input type="date" id="bookSemStart" placeholder="Semester Start">
                    <input type="date" id="bookSemEnd" placeholder="Semester End">
                    <button onclick="testBookHostel()" style="margin-top: 10px;">Create Booking</button>
                </div>
                
                <div class="form-group">
                    <label>Get My Bookings</label>
                    <button onclick="testGetMyBookings()">Fetch My Bookings</button>
                </div>
                
                <div class="output" id="bookingOutput"></div>
            </div>
            
            <!-- PAYMENTS PANEL -->
            <div class="panel">
                <h2>Payments (Auth Required)</h2>
                
                <div class="form-group">
                    <label>Make Payment</label>
                    <input type="text" id="payBookingId" placeholder="Booking ID">
                    <input type="number" id="payAmount" placeholder="Amount">
                    <select id="payMethod">
                        <option value="MPESA">M-Pesa</option>
                        <option value="CARD">Card</option>
                        <option value="BANK">Bank Transfer</option>
                    </select>
                    <button onclick="testMakePayment()" style="margin-top: 10px;">Record Payment</button>
                </div>
                
                <div class="form-group">
                    <label>Get My Payments</label>
                    <button onclick="testGetMyPayments()">Fetch Payments</button>
                </div>
                
                <div class="output" id="paymentOutput"></div>
            </div>
            
            <!-- ISSUES PANEL -->
            <div class="panel">
                <h2>Issues (Auth Required)</h2>
                
                <div class="form-group">
                    <label>Report Issue</label>
                    <input type="text" id="issueBookingId" placeholder="Booking ID">
                    <textarea id="issueDescription" placeholder="Issue description" rows="3"></textarea>
                    <select id="issuePriority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                    </select>
                    <button onclick="testReportIssue()" style="margin-top: 10px;">Report</button>
                </div>
                
                <div class="output" id="issueOutput"></div>
            </div>
            
            <!-- DASHBOARD PANEL -->
            <div class="panel">
                <h2>Dashboard (Auth Required)</h2>
                
                <div class="form-group">
                    <label>Get Student Dashboard</label>
                    <button onclick="testStudentDashboard()">Get Dashboard</button>
                </div>
                
                <div class="form-group">
                    <label>Get Owner Dashboard</label>
                    <button onclick="testOwnerDashboard()">Get Dashboard</button>
                </div>
                
                <div class="output" id="dashboardOutput"></div>
            </div>
            
            <!-- CONSOLE PANEL -->
            <div class="panel full-width">
                <h2>API Console Log</h2>
                <button onclick="clearConsole()" style="margin-bottom: 10px;">Clear Log</button>
                <div class="output" id="console"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let authToken = null;
        let currentUser = null;
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <div class="timestamp">${time}</div>
                <div>${message}</div>
            `;
            
            console.insertBefore(entry, console.firstChild);
            
            // Keep only last 50 entries
            while (console.children.length > 50) {
                console.removeChild(console.lastChild);
            }
        }
        
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                log(`${method} ${endpoint} - Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                return { status: response.status, data: result };
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                return { status: 0, data: null, error: error.message };
            }
        }
        
        function showOutput(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            let html = title ? `<strong>${title}</strong><br>` : '';
            html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.innerHTML = html;
        }
        
        // TEST FUNCTIONS
        async function testRegister() {
            const email = document.getElementById('regEmail').value;
            const name = document.getElementById('regName').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            
            if (!email || !name || !password) {
                alert('Please fill all fields');
                return;
            }
            
            const result = await apiCall('/auth/register/', 'POST', { email, password, name, role });
            
            if (result.status === 201) {
                authToken = result.data.access;
                currentUser = result.data.user;
                localStorage.setItem('access_token', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));
                showOutput('authOutput', result.data, 'Registration Successful');
                log(`Registered as ${result.data.user.email}`, 'success');
            } else {
                showOutput('authOutput', result.data, 'Registration Failed');
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill all fields');
                return;
            }
            
            const result = await apiCall('/auth/login/', 'POST', { email, password });
            
            if (result.status === 200) {
                authToken = result.data.access;
                currentUser = result.data.user;
                localStorage.setItem('access_token', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));
                showOutput('authOutput', result.data, 'Login Successful');
                log(`Logged in as ${result.data.user.email}`, 'success');
            } else {
                showOutput('authOutput', result.data, 'Login Failed');
            }
        }
        
        async function testGetHostels() {
            const result = await apiCall('/hostels/', 'GET');
            showOutput('hostelOutput', result.data);
        }
        
        async function testGetHostel() {
            const id = document.getElementById('hostelId').value;
            if (!id) {
                alert('Please enter hostel ID');
                return;
            }
            const result = await apiCall(`/hostels/${id}/`, 'GET');
            showOutput('hostelOutput', result.data);
        }
        
        async function testBookHostel() {
            const hostelId = document.getElementById('bookHostelId').value;
            const semStart = document.getElementById('bookSemStart').value;
            const semEnd = document.getElementById('bookSemEnd').value;
            
            if (!hostelId || !semStart || !semEnd) {
                alert('Please fill all fields');
                return;
            }
            
            const result = await apiCall('/bookings/create/', 'POST', {
                hostel_id: hostelId,
                semester_start: semStart,
                semester_end: semEnd
            });
            
            showOutput('bookingOutput', result.data);
        }
        
        async function testGetMyBookings() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            const result = await apiCall('/bookings/my/', 'GET');
            showOutput('bookingOutput', result.data);
        }
        
        async function testMakePayment() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            
            const bookingId = document.getElementById('payBookingId').value;
            const amount = document.getElementById('payAmount').value;
            const method = document.getElementById('payMethod').value;
            
            if (!bookingId || !amount) {
                alert('Please fill all fields');
                return;
            }
            
            const result = await apiCall('/payments/make/', 'POST', {
                booking_id: bookingId,
                amount: parseFloat(amount),
                payment_method: method
            });
            
            showOutput('paymentOutput', result.data);
        }
        
        async function testGetMyPayments() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            const result = await apiCall('/payments/my/', 'GET');
            showOutput('paymentOutput', result.data);
        }
        
        async function testReportIssue() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            
            const bookingId = document.getElementById('issueBookingId').value;
            const description = document.getElementById('issueDescription').value;
            const priority = document.getElementById('issuePriority').value;
            
            if (!bookingId || !description) {
                alert('Please fill all fields');
                return;
            }
            
            const result = await apiCall('/issues/report/', 'POST', {
                booking_id: bookingId,
                description: description,
                priority: priority
            });
            
            showOutput('issueOutput', result.data);
        }
        
        async function testStudentDashboard() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            const result = await apiCall('/dashboard/student/', 'GET');
            showOutput('dashboardOutput', result.data, 'Student Dashboard');
        }
        
        async function testOwnerDashboard() {
            if (!authToken) {
                alert('Please login first');
                return;
            }
            const result = await apiCall('/dashboard/owner/', 'GET');
            showOutput('dashboardOutput', result.data, 'Owner Dashboard');
        }
        
        // Initialize
        window.addEventListener('load', () => {
            const token = localStorage.getItem('access_token');
            if (token) {
                authToken = token;
                currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                log(`Auto-logged in as ${currentUser.email}`, 'success');
            }
        });
    </script>
</body>
</html>
