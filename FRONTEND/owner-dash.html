<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - Smart Accommodation</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',sans-serif; background:#f4f6fb; color:#333; }
        header { background:#1e7f74; color:white; padding:20px 30px; display:flex; justify-content:space-between; align-items:center; }
        .logout { background:#e74c3c; border:none; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; }
        .sidebar { display:flex; background:white; box-shadow:0 2px 10px rgba(0,0,0,0.1); flex-wrap:wrap; }
        .sidebar button { flex:1; min-width:120px; padding:15px; border:none; background:transparent; cursor:pointer; color:#666; font-size:13px; transition:.2s; border-bottom:3px solid transparent; }
        .sidebar button.active { color:#1e7f74; border-bottom-color:#1e7f74; }
        .container { padding:30px; }
        .section { display:none; }
        .section.active { display:block; }
        .card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
        .stat { background:white; padding:15px; border-radius:10px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        .stat h4 { color:#666; font-size:11px; margin-bottom:8px; }
        .stat p { font-size:24px; font-weight:bold; color:#1e7f74; }
        h2 { color:#1e7f74; margin-bottom:20px; font-size:24px; }
        h3 { color:#1e7f74; margin:20px 0 15px; font-size:18px; }
        .hostel-item { background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #1e7f74; }
        .hostel-item h4 { color:#1e7f74; margin-bottom:8px; }
        .hostel-item p { color:#666; font-size:13px; margin-bottom:6px; }
        .btn { padding:8px 14px; background:#1e7f74; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:8px; margin-bottom:8px; font-size:13px; }
        .btn-danger { background:#e74c3c; }
        .btn-success { background:#27ae60; }
        .btn:hover { opacity:0.9; }
        .form-group { margin-bottom:15px; }
        label { display:block; margin-bottom:5px; color:#666; font-size:13px; font-weight:500; }
        input, textarea, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-family:inherit; font-size:13px; }
        input:focus, textarea:focus, select:focus { outline:none; border-color:#1e7f74; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000; }
        .modal.active { display:flex; }
        .modal-content { background:white; padding:30px; border-radius:10px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto; }
        .close-modal { float:right; cursor:pointer; font-size:20px; color:#999; }
        .rooms-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; }
        .room-card { background:#f9f9f9; padding:10px; border-radius:6px; text-align:center; border:1px solid #ddd; cursor:pointer; transition:.2s; }
        .room-card:hover { border-color:#1e7f74; }
        .room-card.occupied { background:#ffe6e6; }
        .room-card h5 { color:#1e7f74; margin-bottom:5px; font-size:13px; }
        .room-card .status { font-size:11px; color:#666; }
        .table { width:100%; border-collapse:collapse; margin-top:10px; }
        .table th, .table td { padding:10px; text-align:left; border-bottom:1px solid #eee; font-size:13px; }
        .table th { background:#f5f5f5; color:#1e7f74; font-weight:bold; }
        .status-badge { display:inline-block; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-approved { background:#d4edda; color:#155724; }
        .status-resolved { background:#d4edda; color:#155724; }
        .status-open { background:#cfe2ff; color:#084298; }
        .room-type-builder { background:#f9f9f9; padding:20px; border-radius:8px; margin-top:15px; border:2px dashed #1e7f74; }
        .room-type-row { display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; margin-bottom:10px; align-items:end; }
        .room-type-row input, .room-type-row select { margin:0; }
        .btn-small { padding:6px 10px; font-size:12px; }
        .room-types-list { margin-top:15px; }
        .room-type-item { background:white; padding:12px; border-radius:6px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-left:3px solid #1e7f74; }
        .room-type-info { flex:1; }
        .room-type-info strong { color:#1e7f74; margin-right:15px; }
    </style>
</head>
<body>

<header>
    <h2>üè¢ Owner Dashboard</h2>
    <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="sidebar">
    <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
    <button class="tab-btn" onclick="switchTab('hostels')">My Hostels</button>
    <button class="tab-btn" onclick="switchTab('rooms')">Manage Rooms</button>
    <button class="tab-btn" onclick="switchTab('students')">View Students</button>
    <button class="tab-btn" onclick="switchTab('payments')">Payments</button>
    <button class="tab-btn" onclick="switchTab('issues')">Issues</button>
</div>

<div class="container">
    <!-- OVERVIEW -->
    <div id="overview" class="section active">
        <h2>Welcome, <span id="ownerName">Owner</span>! üëã</h2>
        <div class="grid">
            <div class="stat">
                <h4>Total Hostels</h4>
                <p id="totalHostels">0</p>
            </div>
            <div class="stat">
                <h4>Total Students</h4>
                <p id="totalStudents">0</p>
            </div>
            <div class="stat">
                <h4>Total Rooms</h4>
                <p id="totalRooms">0</p>
            </div>
            <div class="stat">
                <h4>Occupied Rooms</h4>
                <p id="occupiedRooms">0</p>
            </div>
            <div class="stat">
                <h4>Total Revenue</h4>
                <p><span id="totalRevenue">0</span></p>
            </div>
            <div class="stat">
                <h4>Pending Issues</h4>
                <p id="pendingIssues">0</p>
            </div>
        </div>
    </div>

    <!-- HOSTELS -->
    <div id="hostels" class="section">
        <h2>My Hostels</h2>
        <button class="btn btn-success" onclick="openAddHostelModal()">+ Add New Hostel</button>
        <div id="hostelsList" style="margin-top:20px;"></div>
    </div>

    <!-- ROOMS -->
    <div id="rooms" class="section">
        <h2>Manage Rooms</h2>
        <div class="card">
            <h3>Select Hostel</h3>
            <select id="roomsHostelSelect" onchange="loadHostelRooms()">
                <option value="">Choose a hostel...</option>
            </select>
        </div>
        <div class="card">
            <button class="btn btn-success" onclick="openAddRoomModal()">+ Add Extra Room</button>
            <div id="roomsList" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- STUDENTS -->
    <div id="students" class="section">
        <h2>Student Allocations</h2>
        <div class="card">
            <h3>Select Hostel</h3>
            <select id="studentsHostelSelect" onchange="loadHostelStudents()">
                <option value="">Choose a hostel...</option>
            </select>
        </div>
        <div class="card">
            <h3>Booking Requests</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Student Email</th>
                        <th>Status</th>
                        <th>Booking Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- PAYMENTS -->
    <div id="payments" class="section">
        <h2>Payment Management</h2>
        <div class="card">
            <h3>Select Hostel</h3>
            <select id="paymentsHostelSelect" onchange="loadHostelPayments()">
                <option value="">Choose a hostel...</option>
            </select>
        </div>
        <div class="card">
            <h3>Payments Received</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="paymentsBody"></tbody>
            </table>
            <div style="margin-top:15px;">
                <h4>Total Collected: <span id="totalCollected">0</span></h4>
            </div>
        </div>
    </div>

    <!-- ISSUES -->
    <div id="issues" class="section">
        <h2>Maintenance Issues</h2>
        <div class="card">
            <h3>Select Hostel</h3>
            <select id="issuesHostelSelect" onchange="loadHostelIssues()">
                <option value="">Choose a hostel...</option>
            </select>
        </div>
        <div class="card">
            <h3>Open Issues</h3>
            <div id="issuesList"></div>
        </div>
    </div>
</div>

<!-- ADD HOSTEL MODAL -->
<div id="addHostelModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('addHostelModal')">&times;</span>
        <h3>Add New Hostel</h3>
        <form onsubmit="addHostel(event)" style="max-height: 70vh; overflow-y: auto;">
            <div class="form-group">
                <label>Hostel Name *</label>
                <input type="text" id="hostelName" required>
            </div>
            <div class="form-group">
                <label>Location *</label>
                <input type="text" id="hostelLocation" required>
            </div>
            <div class="form-group">
                <label>Hostel Amenities</label>
                <input type="text" id="hostelAmenities" placeholder="e.g., WiFi, Gym, Library, 24/7 Security, Laundry, Cafeteria">
                <small style="color:#666; font-size:11px;">List all facilities and services your hostel provides</small>
            </div>
            <div class="form-group">
                <label>Upload Hostel Images</label>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Select multiple images to showcase your hostel</p>
                <input type="file" id="hostelImages" multiple accept="image/*" onchange="previewImages(event)">
                <div id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
            </div>

            <!-- ROOM TYPES SECTION -->
            <div class="form-group">
                <label>Define Room Types & Quantities *</label>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Add different room types available in your hostel (e.g., Single, Double, Triple)</p>
                
                <div class="room-type-builder">
                    <div class="room-type-row">
                        <div>
                            <label style="margin-bottom:3px;">Room Type</label>
                            <select id="newRoomType">
                                <option value="SINGLE">Single Room</option>
                                <option value="DOUBLE" selected>Double Room</option>
                                <option value="TRIPLE">Triple Room</option>
                            </select>
                        </div>
                        <div>
                            <label style="margin-bottom:3px;">Quantity</label>
                            <input type="number" id="newRoomQty" min="1" value="1" placeholder="Qty">
                        </div>
                        <div>
                            <label style="margin-bottom:3px;">Price/Month</label>
                            <input type="number" id="newRoomPrice" min="0" placeholder="Price">
                        </div>
                        <div>
                            <label style="margin-bottom:3px;">&nbsp;</label>
                            <button type="button" class="btn btn-success btn-small" onclick="addRoomType()">+ Add</button>
                        </div>
                    </div>
                    
                    <div class="room-types-list" id="roomTypesList">
                        <p style="color:#999; font-size:12px; text-align:center;">No room types added yet. Add at least one room type above.</p>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-success" style="margin-top:20px;">Create Hostel</button>
        </form>
    </div>
</div>

<!-- ADD EXTRA ROOM MODAL -->
<div id="addRoomModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('addRoomModal')">&times;</span>
        <h3>Add Extra Room</h3>
        <p style="color:#666; font-size:13px; margin-bottom:20px;">Use this to add additional rooms to your existing hostel.</p>
        <form onsubmit="addExtraRoom(event)">
            <div class="form-group">
                <label>Room Number *</label>
                <input type="text" id="extraRoomNumber" required placeholder="e.g., 101, A-12">
            </div>
            <div class="form-group">
                <label>Room Type *</label>
                <select id="extraRoomType" required>
                    <option value="SINGLE">Single Room</option>
                    <option value="DOUBLE" selected>Double Room</option>
                    <option value="TRIPLE">Triple Room</option>
                </select>
            </div>
            <div class="form-group">
                <label>Price per Month *</label>
                <input type="number" id="extraRoomPrice" min="0" required placeholder="e.g., 5000">
            </div>
            <button type="submit" class="btn btn-success">Add Room</button>
        </form>
    </div>
</div>

<!-- ASSIGN ROOM MODAL -->
<div id="assignRoomModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('assignRoomModal')">&times;</span>
        <h3>Assign Room to Student</h3>
        <form onsubmit="assignRoom(event)">
            <div class="form-group">
                <label>Select Room</label>
                <div class="rooms-grid" id="availableRooms"></div>
            </div>
            <input type="hidden" id="selectedRoomId">
            <input type="hidden" id="selectedBookingId">
            <button type="submit" class="btn btn-success">Assign Room</button>
        </form>
    </div>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:8000/api';
    let authToken = null;
    let currentUser = null;
    let roomTypes = [];

    window.onload = () => {
        const token = localStorage.getItem('access_token');
        const user = localStorage.getItem('user');
        
        if (!token || !user) {
            window.location.href = '/login.html';
            return;
        }
        
        authToken = token;
        currentUser = JSON.parse(user);
        
        if (currentUser.role !== 'owner') {
            window.location.href = '/student-dash.html';
            return;
        }
        
        document.getElementById('ownerName').textContent = currentUser.first_name || currentUser.email;
        loadDashboard();
    };

    async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            }
        };
        if (data) options.body = JSON.stringify(data);
        
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        return res.json();
    }

    async function loadDashboard() {
        const data = await apiCall('/dashboard/owner/');
        document.getElementById('totalHostels').textContent = data.total_hostels || 0;
        document.getElementById('totalStudents').textContent = data.total_students || 0;
        document.getElementById('totalRooms').textContent = data.total_rooms || 0;
        document.getElementById('occupiedRooms').textContent = data.occupied_rooms || 0;
        document.getElementById('totalRevenue').textContent = data.total_revenue || 0;
        document.getElementById('pendingIssues').textContent = data.pending_issues || 0;
        
        loadHostelSelects(data.hostels);
        loadMyHostels();
    }

    async function loadMyHostels() {
        const data = await apiCall('/hostels/my/');
        const hostels = data.hostels || [];
        const html = hostels.map(h => {
            const imagesHtml = h.images && h.images.length > 0 
                ? `<div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto;">
                     ${h.images.map(img => `<img src="${img.image_url}" alt="${img.caption}" style="width: 100px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">`).join('')}
                   </div>`
                : (h.image ? `<img src="${h.image}" alt="${h.name}" style="width: 100%; max-width: 300px; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">` : '');
            
            return `
            <div class="card">
                ${imagesHtml}
                <h3>${h.name}</h3>
                <p><strong>Location:</strong> ${h.location}</p>
                <p><strong>Starting Price:</strong> ${h.price_per_month}/month</p>
                <p><strong>Total Rooms:</strong> ${h.total_rooms} | <strong>Available:</strong> ${h.available_rooms}</p>
                ${h.amenities ? `<p><strong>Amenities:</strong> ${h.amenities}</p>` : ''}
            </div>
        `;
        }).join('');
        
        if (hostels.length === 0) {
            document.getElementById('hostelsList').innerHTML = '<p style="color:#666;">No hostels added yet. Click "Add New Hostel" to get started.</p>';
        } else {
            document.getElementById('hostelsList').innerHTML = html;
        }
    }

    async function loadHostelSelects(hostels) {
        const selects = ['roomsHostelSelect', 'studentsHostelSelect', 'paymentsHostelSelect', 'issuesHostelSelect'];
        const html = hostels.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
        selects.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '<option value="">Choose a hostel...</option>' + html;
        });
    }

    function openAddHostelModal() {
        roomTypes = [];
        document.getElementById('roomTypesList').innerHTML = '<p style="color:#999; font-size:12px; text-align:center;">No room types added yet. Add at least one room type above.</p>';
        document.getElementById('addHostelModal').classList.add('active');
    }

    function addRoomType() {
        const type = document.getElementById('newRoomType').value;
        const qty = parseInt(document.getElementById('newRoomQty').value);
        const price = parseFloat(document.getElementById('newRoomPrice').value);
        
        if (!qty || qty < 1) {
            alert('Please enter a valid quantity');
            return;
        }
        
        if (!price || price < 0) {
            alert('Please enter a valid price');
            return;
        }
        
        roomTypes.push({ type, quantity: qty, price });
        updateRoomTypesList();
        
        document.getElementById('newRoomQty').value = 1;
        document.getElementById('newRoomPrice').value = '';
    }

    function updateRoomTypesList() {
        if (roomTypes.length === 0) {
            document.getElementById('roomTypesList').innerHTML = '<p style="color:#999; font-size:12px; text-align:center;">No room types added yet. Add at least one room type above.</p>';
            return;
        }
        
        const html = roomTypes.map((rt, index) => `
            <div class="room-type-item">
                <div class="room-type-info">
                    <strong>${rt.type}</strong>
                    <span style="color:#666;">Quantity: ${rt.quantity} rooms</span>
                    <span style="color:#666; margin-left:15px;">Price: ${rt.price}/month</span>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeRoomType(${index})">Remove</button>
            </div>
        `).join('');
        
        document.getElementById('roomTypesList').innerHTML = html;
    }

    function removeRoomType(index) {
        roomTypes.splice(index, 1);
        updateRoomTypesList();
    }

    function previewImages(event) {
        const files = event.target.files;
        const previewDiv = document.getElementById('imagePreview');
        previewDiv.innerHTML = '';
        
        for (let file of files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.borderRadius = '6px';
                img.style.objectFit = 'cover';
                img.style.border = '2px solid #ddd';
                previewDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }

    async function addHostel(e) {
        e.preventDefault();
        
        if (roomTypes.length === 0) {
            alert('Please add at least one room type');
            return;
        }
        
        const files = document.getElementById('hostelImages').files;
        const images = [];
        
        if (files.length > 0) {
            for (let file of files) {
                const reader = new FileReader();
                await new Promise((resolve) => {
                    reader.onload = function(e) {
                        images.push(e.target.result);
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }
        }
        
        const res = await apiCall('/hostels/add/', 'POST', {
            name: document.getElementById('hostelName').value,
            location: document.getElementById('hostelLocation').value,
            amenities: document.getElementById('hostelAmenities').value,
            images: images,
            room_types: roomTypes
        });
        
        if (res.message) {
            alert('Hostel and rooms added successfully!');
            document.getElementById('hostelImages').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.querySelector('#addHostelModal form').reset();
            roomTypes = [];
            closeModal('addHostelModal');
            loadDashboard();
        } else {
            alert(res.error || 'Failed to add hostel');
        }
    }

    function openAddRoomModal() {
        const hostelId = document.getElementById('roomsHostelSelect').value;
        if (!hostelId) {
            alert('Please select a hostel first');
            return;
        }
        document.getElementById('addRoomModal').classList.add('active');
    }

    async function addExtraRoom(e) {
        e.preventDefault();
        const hostelId = document.getElementById('roomsHostelSelect').value;
        const type = document.getElementById('extraRoomType').value;
        
        // Auto-set capacity based on room type
        let capacity = 1;
        if (type === 'DOUBLE') capacity = 2;
        else if (type === 'TRIPLE') capacity = 3;
        
        const res = await apiCall('/rooms/add/', 'POST', {
            hostel_id: hostelId,
            room_number: document.getElementById('extraRoomNumber').value,
            room_type: type,
            capacity: capacity,
            floor: 1,
            price_per_month: parseFloat(document.getElementById('extraRoomPrice').value)
        });
        
        if (res.message) {
            alert('Room added successfully!');
            document.querySelector('#addRoomModal form').reset();
            closeModal('addRoomModal');
            loadHostelRooms();
        } else {
            alert(res.error || 'Failed to add room');
        }
    }

    async function loadHostelRooms() {
        const hostelId = document.getElementById('roomsHostelSelect').value;
        if (!hostelId) return;
        
        const data = await apiCall(`/rooms/hostel/${hostelId}/`);
        const html = data.rooms.map(r => `
            <div class="hostel-item">
                <h4>Room ${r.room_number} (${r.room_type})</h4>
                <p>Price: ${r.price_per_month}/month</p>
                <p>Status: ${r.is_occupied ? 'üî¥ Occupied' : 'üü¢ Available'}</p>
            </div>
        `).join('');
        document.getElementById('roomsList').innerHTML = html || '<p style="color:#999;">No rooms found for this hostel.</p>';
    }

    async function loadHostelStudents() {
        const hostelId = document.getElementById('studentsHostelSelect').value;
        if (!hostelId) {
            document.getElementById('bookingsBody').innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">Please select a hostel first</td></tr>';
            return;
        }
        
        try {
            const data = await apiCall(`/bookings/owner/${hostelId}/`);
            const bookings = data.bookings || [];
            
            if (bookings.length === 0) {
                document.getElementById('bookingsBody').innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No bookings yet for this hostel</td></tr>';
                return;
            }
            
            const html = bookings.map(b => `
                <tr>
                    <td>
                        ${b.user.email}
                        ${b.preferred_room_type ? `<br><small style="color:#666;">Prefers: <strong style="color:#1e7f74;">${b.preferred_room_type}</strong></small>` : ''}
                    </td>
                    <td><span class="status-badge status-${b.status.toLowerCase()}">${b.status}</span></td>
                    <td>${new Date(b.booking_date).toLocaleDateString()}</td>
                    <td>
                        ${b.status === 'PENDING' ? `<button class="btn" onclick="approveBooking('${b.id}', '${hostelId}', '${b.preferred_room_type || ''}')">Approve</button>` : ''}
                        ${b.status === 'PENDING' ? `<button class="btn btn-danger" onclick="rejectBooking('${b.id}')">Reject</button>` : ''}
                        ${b.status === 'FINAL_ALLOCATED' ? '<span style="color: green; font-weight: bold;">‚úì Allocated</span>' : ''}
                        ${b.status === 'CANCELLED' ? '<span style="color: red;">‚úó Rejected</span>' : ''}
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('bookingsBody').innerHTML = html;
        } catch (error) {
            console.error('Error loading bookings:', error);
            document.getElementById('bookingsBody').innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Error loading bookings</td></tr>';
        }
    }

    async function loadHostelPayments() {
        const hostelId = document.getElementById('paymentsHostelSelect').value;
        if (!hostelId) return;
        
        const data = await apiCall(`/payments/hostel/${hostelId}/`);
        const html = data.payments.map(p => `
            <tr>
                <td>${p.student}</td>
                <td>${p.amount}</td>
                <td>${p.method}</td>
                <td><span class="status-badge status-${p.status.toLowerCase()}">${p.status}</span></td>
                <td>${new Date(p.created_at).toLocaleDateString()}</td>
            </tr>
        `).join('');
        document.getElementById('paymentsBody').innerHTML = html;
        document.getElementById('totalCollected').textContent = data.total_collected || 0;
    }

    async function loadHostelIssues() {
        const hostelId = document.getElementById('issuesHostelSelect').value;
        if (!hostelId) return;
        
        const data = await apiCall(`/issues/owner/${hostelId}/`);
        const html = data.issues.map(i => `
            <div class="hostel-item">
                <h4>${i.title} <span class="status-badge status-${i.status.toLowerCase()}">${i.status}</span></h4>
                <p>${i.description}</p>
                <p>Priority: <strong>${i.priority}</strong> | Reported by: ${i.user}</p>
                ${i.status !== 'RESOLVED' ? `<button class="btn" onclick="resolveIssue('${i.id}')">Mark Resolved</button>` : ''}
            </div>
        `).join('');
        document.getElementById('issuesList').innerHTML = html;
    }

    async function approveBooking(bookingId, hostelId, preferredType) {
        document.getElementById('selectedBookingId').value = bookingId;
        const data = await apiCall(`/rooms/hostel/${hostelId}/`);
        
        let availableRooms = data.rooms.filter(r => !r.is_occupied);
        if (preferredType) {
            availableRooms = availableRooms.filter(r => r.room_type === preferredType);
        }
        
        if (availableRooms.length === 0 && preferredType) {
            alert(`No available ${preferredType} rooms. Please reject this booking or wait for availability.`);
            return;
        }
        
        const html = availableRooms.map(r => `
            <div class="room-card" onclick="selectRoom('${r.id}')">
                <h5>Room ${r.room_number}</h5>
                <div class="status">${r.room_type}</div>
                <div class="status">${r.price_per_month}</div>
                ${r.room_type === preferredType ? '<div style="color:green; font-size:10px; margin-top:5px;">‚úì Matches preference</div>' : ''}
            </div>
        `).join('');
        document.getElementById('availableRooms').innerHTML = html || '<p style="color:#999;">No available rooms</p>';
        document.getElementById('assignRoomModal').classList.add('active');
    }

    function selectRoom(roomId) {
        document.getElementById('selectedRoomId').value = roomId;
        document.querySelectorAll('.room-card').forEach(c => c.style.borderColor = '#ddd');
        event.target.closest('.room-card').style.borderColor = '#1e7f74';
    }

    async function assignRoom(e) {
        e.preventDefault();
        const bookingId = document.getElementById('selectedBookingId').value;
        const roomId = document.getElementById('selectedRoomId').value;
        
        if (!roomId) {
            alert('Please select a room');
            return;
        }
        
        const res = await apiCall(`/bookings/${bookingId}/approve/`, 'POST', { room_id: roomId });
        if (res.message) {
            alert('Room assigned successfully!');
            closeModal('assignRoomModal');
            loadHostelStudents();
        }
    }

    async function rejectBooking(bookingId) {
        if (confirm('Are you sure you want to reject this booking?')) {
            await apiCall(`/bookings/${bookingId}/reject/`, 'POST', { reason: 'Rejected by owner' });
            alert('Booking rejected');
            loadHostelStudents();
        }
    }

    async function resolveIssue(issueId) {
        if (confirm('Mark this issue as resolved?')) {
            await apiCall(`/issues/${issueId}/resolve/`, 'POST', { notes: 'Resolved' });
            alert('Issue marked as resolved');
            loadHostelIssues();
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
    }
</script>

</body>
</html>